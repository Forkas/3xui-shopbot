{% extends "base.html" %} {% block title %}Главная страница{% endblock %} {% block content %}

<div class="page-header d-print-none">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="page-title">Главная</h2>
      <div class="text-secondary">Сводка и ключевые метрики</div>
    </div>
  </div>
  <div id="dash-stats" class="row row-deck row-cards mt-2"
       data-fetch-url="{{ url_for('dashboard_stats_partial') }}"
       data-fetch-interval="8000">
    {% include 'partials/dashboard_stats.html' %}
  </div>
</div>

<div class="row row-cards">
  <div class="col-lg-7">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Новые пользователи (30 дней)</h3>
      </div>
      <div class="card-body">
        <div class="chart" style="height: 280px">
          <canvas id="newUsersChart"></canvas>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header">
        <h3 class="card-title">Новые ключи (30 дней)</h3>
      </div>
      <div class="card-body">
        <div class="chart" style="height: 280px">
          <canvas id="newKeysChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Недавние транзакции</h3>
      </div>
      <div class="card-body">
        {% if transactions %}
        <div class="table-responsive">
          <table class="table table-vcenter">
            <thead>
              <tr>
                <th>Пользователь</th>
                <th>Хост</th>
                <th>План</th>
                <th>Цена</th>
                <th>Дата</th>
              </tr>
            </thead>
            <tbody id="dash-transactions"
                   data-fetch-url="{{ url_for('dashboard_transactions_partial', page=current_page) }}"
                   data-fetch-interval="10000">
              {% include 'partials/dashboard_transactions.html' %}
            </tbody>
          </table>
        </div>

        {% if total_pages > 1 %}
        <div class="d-flex justify-content-center mt-3">
          <ul class="pagination">
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('dashboard_page', page=current_page - 1) }}" aria-label="Previous">«</a>
            </li>
            {% for p in range(1, total_pages + 1) %}
            <li class="page-item {% if p == current_page %}active{% endif %}">
              <a class="page-link" href="{{ url_for('dashboard_page', page=p) }}">{{ p }}</a>
            </li>
            {% endfor %}
            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('dashboard_page', page=current_page + 1) }}" aria-label="Next">»</a>
            </li>
          </ul>
        </div>
        {% endif %}
        {% else %}
        <p class="text-secondary">Пока нет транзакций для отображения.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script id="chart-data" type="application/json">
  {{ chart_data | tojson }}
</script>
<script>
  const CHART_DATA = JSON.parse(document.getElementById('chart-data').textContent);
</script>

{% endblock %}
