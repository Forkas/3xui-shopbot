{% extends 'base.html' %}
{% block title %}Тикет #{{ ticket.ticket_id }} — Поддержка{% endblock %}

{% block content %}
<section class="section" id="ticket-root" data-ticket-id="{{ ticket.ticket_id }}">
  <a class="button" href="{{ url_for('support_list_page') }}">← К списку</a>
  <h1>Тикет #{{ ticket.ticket_id }}</h1>
  <p><strong>Пользователь:</strong> {{ ticket.user_id }}</p>
  <p><strong>Тема:</strong> {{ ticket.subject or 'Без темы' }}</p>
  <p>
    <strong>Статус:</strong>
    <span id="ticket-status">
      {% if ticket.status == 'open' %}
        <span class="indicator indicator-lg indicator--green pulse"></span>
        <span class="badge badge-green">Открыт</span>
      {% else %}
        <span class="indicator indicator-lg indicator--gray"></span>
        <span class="badge">Закрыт</span>
      {% endif %}
    </span>
  </p>

  <div class="chat-box" id="chat-box">
    {% for m in messages %}
      <div class="chat-message {% if m.sender == 'admin' %}from-admin{% else %}from-user{% endif %}">
        <div class="meta">
          <span class="sender">{{ 'Админ' if m.sender == 'admin' else 'Пользователь' }}</span>
          <span class="time">{{ m.created_at }}</span>
        </div>
        <div class="content">{{ m.content }}</div>
      </div>
    {% else %}
      <p class="no-messages">Сообщений пока нет.</p>
    {% endfor %}
  </div>

  <div class="ticket-actions">
    <form method="post" class="form-inline" id="reply-form">
      <textarea id="reply-text" name="message" rows="3" placeholder="Введите ответ админа..." {% if ticket.status == 'closed' %}disabled{% endif %}></textarea>
      <div class="buttons">
        <button id="reply-btn" type="submit" name="action" value="reply" class="button button-primary" {% if ticket.status == 'closed' %}disabled{% endif %}>Ответить</button>
        {% if ticket.status == 'open' %}
          <button id="toggle-status-btn" type="submit" name="action" value="close" class="button button-danger">Закрыть</button>
        {% else %}
          <button id="toggle-status-btn" type="submit" name="action" value="open" class="button button-start">Открыть</button>
        {% endif %}
      </div>
    </form>
    <form method="post" action="{{ url_for('delete_support_ticket_route', ticket_id=ticket.ticket_id) }}" onsubmit="return confirm('Удалить тикет #{{ ticket.ticket_id }}? Это действие необратимо.');" style="display:inline-block;margin-top:8px;">
      <button type="submit" class="button button-danger">Удалить тикет</button>
    </form>
  </div>
</section>
{% endblock %}
